% [!] metric 1
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.258229
% [*] Mean consistency across pairs: 0.133813
% [*] Mean consistency across subjects: 0.067452
% [*] Median mag: 0.215985
% [*] Median consistency across pairs: 0.100000
% [*] Median consistency across subjects: 0.055556
% [*] Stdev mag: 0.117429
% [*] Stdev consistency across pairs: 0.103294
% [*] Stdev consistency across subjects: 0.041867
% [!] metric 2
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.488160
% [*] Mean consistency across pairs: 0.108153
% [*] Mean consistency across subjects: 0.048406
% [*] Median mag: 0.464417
% [*] Median consistency across pairs: 0.076923
% [*] Median consistency across subjects: 0.040000
% [*] Stdev mag: 0.106114
% [*] Stdev consistency across pairs: 0.100187
% [*] Stdev consistency across subjects: 0.024484
% [!] metric 3
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.364766
% [*] Mean consistency across pairs: 0.136532
% [*] Mean consistency across subjects: 0.064637
% [*] Median mag: 0.299158
% [*] Median consistency across pairs: 0.100000
% [*] Median consistency across subjects: 0.052632
% [*] Stdev mag: 0.169842
% [*] Stdev consistency across pairs: 0.112555
% [*] Stdev consistency across subjects: 0.040198
% [!] metric 4
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.396679
% [*] Mean consistency across pairs: 0.091285
% [*] Mean consistency across subjects: 0.056208
% [*] Median mag: 0.324382
% [*] Median consistency across pairs: 0.071429
% [*] Median consistency across subjects: 0.043478
% [*] Stdev mag: 0.189268
% [*] Stdev consistency across pairs: 0.068317
% [*] Stdev consistency across subjects: 0.034575
% [!] metric 5
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.268754
% [*] Mean consistency across pairs: 0.120833
% [*] Mean consistency across subjects: 0.065539
% [*] Median mag: 0.223001
% [*] Median consistency across pairs: 0.093750
% [*] Median consistency across subjects: 0.054054
% [*] Stdev mag: 0.118302
% [*] Stdev consistency across pairs: 0.095282
% [*] Stdev consistency across subjects: 0.044795


% == April 4 == 
% [!] metric 1
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.261896
% [*] Mean consistency across pairs: 0.167989
% [*] Mean consistency across subjects: 0.067884
% [*] Median mag: 0.218882
% [*] Median consistency across pairs: 0.136364
% [*] Median consistency across subjects: 0.057143
% [*] Stdev mag: 0.120156
% [*] Stdev consistency across pairs: 0.115198
% [*] Stdev consistency across subjects: 0.040502
% [!] metric 2
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.487029
% [*] Mean consistency across pairs: 0.155464
% [*] Mean consistency across subjects: 0.050635
% [*] Median mag: 0.466332
% [*] Median consistency across pairs: 0.111111
% [*] Median consistency across subjects: 0.043478
% [*] Stdev mag: 0.098656
% [*] Stdev consistency across pairs: 0.124768
% [*] Stdev consistency across subjects: 0.024543
% [!] metric 3
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.363659
% [*] Mean consistency across pairs: 0.172772
% [*] Mean consistency across subjects: 0.066100
% [*] Median mag: 0.298279
% [*] Median consistency across pairs: 0.135593
% [*] Median consistency across subjects: 0.055556
% [*] Stdev mag: 0.171318
% [*] Stdev consistency across pairs: 0.124792
% [*] Stdev consistency across subjects: 0.039399
% [!] metric 4
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.411832
% [*] Mean consistency across pairs: 0.131240
% [*] Mean consistency across subjects: 0.057833
% [*] Median mag: 0.338222
% [*] Median consistency across pairs: 0.105263
% [*] Median consistency across subjects: 0.047619
% [*] Stdev mag: 0.195936
% [*] Stdev consistency across pairs: 0.086306
% [*] Stdev consistency across subjects: 0.032944
% [!] metric 5
% [*] Loading cached distance matrix: /home/jerry/data/stats/cache/fig_cluster2_X.mat ..
% [*] Loading cached kmeans: /home/jerry/data/stats/cache/fig_cluster2_kmeans.mat ..
% [*] Mean mag: 0.275097
% [*] Mean consistency across pairs: 0.157330
% [*] Mean consistency across subjects: 0.066672
% [*] Median mag: 0.229893
% [*] Median consistency across pairs: 0.125000
% [*] Median consistency across subjects: 0.055556
% [*] Stdev mag: 0.120646
% [*] Stdev consistency across pairs: 0.107767
% [*] Stdev consistency across subjects: 0.042479

close all;
clear;
rng(1);

% number of final locations
n_loc = 150;
sphere_radius = 100;

% threshold by number of unique subjects
thresh_nsub = 1; %2;
thresh_npair = 5; %10;
cp_thresh_override = 0.05; %1/200; %0.05;

% load surface
subjects_dir = '/media/klab/internal/data/coreg';
[s_vert, faces] = read_surf(sprintf('%s/%s/surf/%sh.%s',subjects_dir,'fsaverage_sym','r','sphere'));

for iM = 1:5
    fprintf('[!] metric %i\n',iM);
    
    fn_ca1 = sprintf('/home/jerry/data/stats/cache/fig_cluster2_A_%i.mat',iM);
    Ca1 = load(fn_ca1);
    fn_ca2 = sprintf('/home/jerry/data/stats/cache/fig_cluster2_reduce_%i.mat',iM);
    Ca2 = load(fn_ca2);
    fn_ca2_new = sprintf('/home/jerry/data/stats/cache/fig_cluster2_reduce_%i_new.mat',iM);
    
    fn_ca = '/home/jerry/data/stats/cache/fig_cluster2_X.mat';
    
    if (exist(fn_ca,'file'))
        fprintf('[*] Loading cached distance matrix: %s ..\n',fn_ca);
        Ca = load(fn_ca);
        X = Ca.X;
    else
        fprintf('[*] Computing distance matrix, this may take a while ..\n');
        n_bchan = length(Ca1.A);
        X = zeros(n_bchan,n_bchan);
        for i = 1:(n_bchan-1)
            for j = (i+1):n_bchan
                % Points on a sphere
                u = Ca1.E_sphere(i,3:5);
                v = Ca1.E_sphere(j,3:5);

                % Arclength
                theta = atan2d(norm(cross(u,v)),dot(u,v));
                theta = theta * (2*pi/360);
                arcl = theta*sphere_radius;

                X(i,j) = arcl;
                X(j,i) = arcl;
            end
        end
        fprintf('[*] Saving distance matrix cache to: %s ..\n',fn_ca);
        save(fn_ca,'X');
    end
    
    
    
    fn_ca = '/home/jerry/data/stats/cache/fig_cluster2_kmeans.mat';
    
    if (exist(fn_ca,'file'))
        fprintf('[*] Loading cached kmeans: %s ..\n',fn_ca);
        Ca = load(fn_ca);
        idx = Ca.idx;
        C = Ca.C;
        sumd = Ca.sumd;
        D = Ca.D;
        n_rep = Ca.n_rep;
        maxiter = Ca.maxiter;
    else
        fprintf('[*] k-means clustring, this may take a while ..\n');
        % kmeans cluster by distance
        n_rep = 10; %3*30;
        maxiter = 10000; %3*10000;
        stream = RandStream('mlfg6331_64');  % Random number stream
        options = statset('UseParallel',1,'UseSubstreams',1,...
        'Streams',stream);
        [idx,C,sumd,D] = kmeans(X,n_loc,'Options',options,'MaxIter',maxiter,...
            'Display','final','Replicates',n_rep);
        save(fn_ca,'idx','C','sumd','D','n_rep','maxiter');
    end
    
    %%
    % organize output
    
    % nsig
    n_E = length(Ca1.E);
    A_sav = Ca1.A;
    E_nsig = zeros(n_E,1);
    for ies = 1:n_E
        n_sig = sum((~isnan(A_sav(ies,:)))&(A_sav(ies,:) ~= 0));
        E_nsig(ies) = n_sig;
%         Es{ies} = E(ies,:);
%         Es2{ies} = [E(ies,:),n_sig];
%         Es_sphere{ies} = E_sphere(ies,:);
    end
    
    % combine electrode level
    Es = cell(n_loc,1);
    Es2 = cell(n_loc,1);
    Es_sphere = cell(n_loc,1);
    E = nan(size(Ca2.E));
    E_sphere = nan(size(Ca2.E_sphere));
    for i = 1:n_loc
        id = (idx == i);
       
        Ei = Ca1.E(id,:);
        Ei_nsig = E_nsig(id,:);
        Ei_sphere = Ca1.E_sphere(id,:);
        
        % Choose representative electrode
        mcoord = mean(Ei(:,3:5),1);
        mdist = sqrt(sum((Ei(:,3:5) - mcoord).^2,2));
        [~,sIdx] = min(mdist);
        E(i,:) = Ei(sIdx,:);
        E_sphere(i,:) = Ei_sphere(sIdx,:);
        
        Es{i} = Ei;
        Es2{i} = [Ei,Ei_nsig];
        Es_sphere{i} = Ei_sphere;
    end
    
    % combine interactions
    A = zeros(n_loc,n_loc);
    A_nocov = zeros(n_loc,n_loc);
    Act = zeros(n_loc,n_loc);
    Act_nocov = zeros(n_loc,n_loc);
    Ad = zeros(n_loc,n_loc);
    Acp = zeros(n_loc,n_loc);
    Acs = zeros(n_loc,n_loc);
    A_npairs = zeros(n_loc,n_loc);
    A_nusubs = zeros(n_loc,n_loc);
    A_median = zeros(n_loc,n_loc);
    for i = 1:n_loc
        for j = i:n_loc
            a = Ca1.A(i==idx,j==idx);
            a_nocov = Ca1.A_nocov(i==idx,j==idx);
            act = Ca1.Act(i==idx,j==idx);
            act_nocov = Ca1.Act_nocov(i==idx,j==idx);
            ad = Ca1.Ad(i==idx,j==idx);
            ei = Ca1.E(i==idx,:);
            ej = Ca1.E(j==idx,:);
            usub = unique([Es{i}(:,1); Es{j}(:,1)]);
            
%             for i2 = 1:(length(a) - 0)
%                 for j2 = (i2 + 0):length(a)
%                     a(j2,i2) = NaN;
%                     a_nocov(j2,i2) = NaN;
%                     act(j2,i2) = NaN;
%                     act_nocov(j2,i2) = NaN;
%                 end
%             end
            
            
            % check for coverage
            n_usub = length(usub);
            n_pairs = sum(sum(~isnan(a_nocov)));
            
             % number of significant subjects
            sig_usub = zeros(size(usub));
            for iss = 1:n_usub
                sint = usub(iss);
                eIdx = (Ca1.E(:,1) == sint);
                i_mask = (i == idx);
                j_mask = (j == idx);
                im = i_mask & eIdx;
                jm = j_mask & eIdx;
                sig_usub(iss) = any(~isnan(reshape(Ca1.A(im,jm),1,[])));
%                 if (~isempty(Ca1.A(im,jm)))
%                     return
%                 end
            end
            n_sig_usub = sum(sig_usub);
%             
%             if ((i == 29) && (j == 113))
%                 fprintf('\t(*) n_sig_usub: %i\n',n_sig_usub);
%                 return
%             end
                
            if ((n_usub >= thresh_nsub) && (n_pairs >= thresh_npair))
                
                % distance is always valid as long as there is coverage
                ad = nanmean(ad(:));
                
                % check for consistency across subjects
                n_sig_pairs = sum(sum((~isnan(a_nocov)) & (a_nocov ~= 0)));
                cp = (n_sig_pairs/n_pairs);
                cs = (n_sig_usub/n_usub);
                if (cp >= cp_thresh_override)
                    
                    a = nanmean(a(a~=0));
                    act = nanmean(act(act~=0));
                    a_median = nanmedian(a(a~=0));

                    if (all(isnan(a_nocov)))
                        a_nocov = nan;
                    else
                        if (all(a_nocov(~isnan(a_nocov)) == 0))
                            a_nocov = 0;
                        else
                            a_nocov = nanmean(a_nocov((a_nocov)~= 0));
                        end
                    end
                    if (all(isnan(act_nocov)))
                        act_nocov = nan;
                    else
                        if (all(act_nocov(~isnan(act_nocov)) == 0))
                            act_nocov = 0;
                        else
                            act_nocov = nanmean(act_nocov((act_nocov)~= 0));
                        end
                    end
                
                else
                    % not significant across subjects
                    a = NaN;
                    a_nocov = 0;
                    act = NaN;
                    act_nocov = 0;
                    cp = 0;
                    cs = 0;
                    a_median = 0;
                end
            else
                % not enough subjects or pairs
                a = NaN;
                a_nocov = NaN;
                act = NaN;
                act_nocov = NaN;
                ad = NaN;
                cp = NaN;
                cs = NaN;
                a_median = NaN;
            end
            
%             if ((i == 110) && (j == 114))
%                 return
%             end
            
            
            A(i,j) = a;
            A(j,i) = a;
            A_nocov(i,j) = a_nocov;
            A_nocov(j,i) = a_nocov;
            Act(i,j) = act;
            Act(j,i) = act;
            Act_nocov(i,j) = act_nocov;
            Act_nocov(j,i) = act_nocov;
            Ad(i,j) = ad;
            Ad(j,i) = ad;
            Acp(i,j) = cp;
            Acp(j,i) = cp;
            Acs(i,j) = cs;
            Acs(j,i) = cs;
            A_npairs(i,j) = n_pairs;
            A_npairs(j,i) = n_pairs;
            A_nusubs(i,j) = n_usub;
            A_nusubs(j,i) = n_usub;
            A_median(i,j) = a_median;
            A_median(j,i) = a_median;
        end
    end
    
    ss_samesid = Ca2.ss_samesid;
    ss_thresh_mm = Ca2.ss_thresh_mm;
    
    fprintf('[*] Mean mag: %.6f\n',nanmean(A(:)));
    fprintf('[*] Mean consistency across pairs: %.6f\n',nanmean(Acp(~isnan(A))));
    fprintf('[*] Mean consistency across subjects: %.6f\n',nanmean(Acs(~isnan(A))));
    fprintf('[*] Median mag: %.6f\n',nanmedian(A(:)));
    fprintf('[*] Median consistency across pairs: %.6f\n',nanmedian(Acp(~isnan(A))));
    fprintf('[*] Median consistency across subjects: %.6f\n',nanmedian(Acs(~isnan(A))));
    fprintf('[*] Stdev mag: %.6f\n',nanstd(A(:)));
    fprintf('[*] Stdev consistency across pairs: %.6f\n',nanstd(Acp(~isnan(A))));
    fprintf('[*] Stdev consistency across subjects: %.6f\n',nanstd(Acs(~isnan(A))));
    
    
    save(fn_ca2_new,'A','A_nocov','Act','Act_nocov','Ad','Acp','Acs',...
        'E','E_sphere','Es','Es2','Es_sphere','ss_samesid','ss_thresh_mm',...
        'A_npairs','A_nusubs','thresh_nsub','thresh_npair','cp_thresh_override','A_median');
end